---
import BaseLayout from '../layouts/BaseLayout.astro'
import TopLayout from '../layouts/TopLayout.astro'
import BottomLayout from '../layouts/BottomLayout.astro'
import ProjectCard from '../components/ProjectCard.astro'

import { contentfulClient } from '../lib/contentful'

// fallback sample projects using local public images
const SAMPLE_PROJECTS = [
  {
    id: 'p1',
    name: 'Career Guidance App',
    description: 'Career portal with recommendations and user-friendly UI.',
    img: '/career.png',
    website: '#',
    repo: '#',
  },
  {
    id: 'p2',
    name: 'Hospital Management System',
    description: 'Full-stack hospital management system built to digitalize workflows.',
    img: '/hospital.png',
    website: '#',
    repo: '#',
  },
  {
    id: 'p3',
    name: 'E-Kart Shopping App',
    description: 'E-commerce UI clone with cart, filters and modern UX.',
    img: '/ekart.png',
    website: '#',
    repo: '#',
  },
  {
    id: 'p4',
    name: 'NewsDuniya',
    description: 'Live news dashboard with real-time updates.',
    img: '/newsduniya.png',
    website: '#',
    repo: '#',
  },
  {
    id: 'p5',
    name: 'Sticker Generator',
    description: 'Generate & download funny stickers instantly.',
    img: '/sticker.png',
    website: '#',
    repo: '#',
  },
]

let entries = { items: [] }
try {
  const res = await contentfulClient.getEntries({})
  if (res && res.items && res.items.length) entries = res
} catch (err) {
  console.warn('Contentful fetch failed, using sample projects', err)
}

const getImageUrl = (asset) => {
  if (!asset) return ''
  const url = asset?.fields?.file?.url ?? ''
  if (!url) return ''
  if (url.startsWith('//')) return `https:${url}`
  if (url.startsWith('http')) return url
  return `https:${url}`
}

const projects = (entries?.items && entries.items.length > 0)
  ? entries.items.map((entry: any) => ({
      id: entry?.sys?.id,
      name: entry?.fields?.name ?? 'Untitled',
      description: entry?.fields?.description ?? '',
      img: getImageUrl(entry?.fields?.img),
      website: entry?.fields?.website ?? '',
      repo: entry?.fields?.repo ?? entry?.fields?.repositorio ?? '',
    }))
  : SAMPLE_PROJECTS
---
<BaseLayout title="Portfolio" description="Projects and clones">
  <main class="min-h-[80vh]">
    <TopLayout>
      <div class="w-full flex justify-center">
        <div class="w-full max-w-5xl px-4">
          <h2 class="text-center scroll-m-20 border-b pb-2 text-3xl font-semibold tracking-tight">
            Projects and clone's
          </h2>
        </div>
      </div>
    </TopLayout>

    <BottomLayout size="xl">
      <div class="w-full flex justify-center">
        <div class="w-full max-w-5xl px-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            {projects.map((p) => (
              <ProjectCard
                key={p.id}
                href={p.website || undefined}
                heading={p.name}
                subheading={p.description}
                imagePath={p.img}  
                altText={p.name}
                class="w-full"
                repo={p.repo}
                live={p.website}
              />
            ))}
          </div>
        </div>
      </div>
    </BottomLayout>
  </main>
</BaseLayout>
