---
import BaseLayout from '../layouts/BaseLayout.astro'
import TopLayout from '../layouts/TopLayout.astro'
import BottomLayout from '../layouts/BottomLayout.astro'
import ProjectCard from '../components/ProjectCard.astro'

import { contentfulClient } from '../lib/contentful'

// fallback sample projects...
const SAMPLE_PROJECTS = [
  { id: 'p1', name: 'SkincareConnect (Demo)', description: 'AI-driven skincare...', img: 'https://images.unsplash.com/photo-1545239351-1141bd82e8a6?w=1400&q=80&auto=format&fit=crop', website: '#', repo: '#' },
  { id: 'p2', name: 'Hospital Management (Demo)', description: 'Digitalized hospital...', img: 'https://images.unsplash.com/photo-1587502536263-3f77a9b1d3f1?w=1400&q=80&auto=format&fit=crop', website: '#', repo: '#' },
  { id: 'p3', name: 'Portfolio UI Clone', description: 'Astro + Tailwind + shadcn-ui', img: 'https://images.unsplash.com/photo-1551434678-e076c223a692?w=1400&q=80&auto=format&fit=crop', website: '#', repo: '#' },
  { id: 'p4', name: 'Todo App (Demo)', description: 'Fast todo app', img: 'https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=1400&q=80&auto=format&fit=crop', website: '#', repo: '#' },
  { id: 'p5', name: 'Chat UI Demo', description: 'Realtime chat UI', img: 'https://images.unsplash.com/photo-1519389950473-47ba0277781c?w=1400&q=80&auto=format&fit=crop', website: '#', repo: '#' },
  { id: 'p6', name: 'Analytics Dashboard', description: 'charts + filters', img: 'https://images.unsplash.com/photo-1526378722353-0f2e8e6b0b30?w=1400&q=80&auto=format&fit=crop', website: '#', repo: '#' },
]

let entries = { items: [] }
try {
  const res = await contentfulClient.getEntries({})
  if (res && res.items && res.items.length) entries = res
} catch (err) {
  console.warn('Contentful fetch failed, using sample projects', err)
}

const getImageUrl = (asset) => {
  if (!asset) return ''
  const url = asset?.fields?.file?.url ?? ''
  if (!url) return ''
  if (url.startsWith('//')) return `https:${url}`
  if (url.startsWith('http')) return url
  return `https:${url}`
}

const projects = (entries?.items && entries.items.length > 0)
  ? entries.items.map((entry: any) => ({
      id: entry?.sys?.id,
      name: entry?.fields?.name ?? 'Untitled',
      description: entry?.fields?.description ?? '',
      img: getImageUrl(entry?.fields?.img),
      website: entry?.fields?.website ?? '',
      repo: entry?.fields?.repo ?? entry?.fields?.repositorio ?? '',
    }))
  : SAMPLE_PROJECTS
---
<BaseLayout title="Portfolio" description="Projects and clones">
  <main class="min-h-[80vh]">
    <TopLayout>
      <!-- Center heading (full-width wrapper ensures correct centering) -->
      <div class="w-full flex justify-center">
        <div class="w-full max-w-5xl px-4">
          <h2 class="text-center scroll-m-20 border-b pb-2 text-3xl font-semibold tracking-tight">Projects and clone's</h2>
        </div>
      </div>
    </TopLayout>

    <BottomLayout size="xl">
      <!-- CENTERED GRID WRAPPER: this guarantees centering even if BottomLayout adds padding -->
      <div class="w-full flex justify-center">
        <!-- max-w constrains content and centers it -->
        <div class="w-full max-w-5xl px-4">
          <!-- Grid: 1 col on mobile, 2 cols on sm+, consistent gap -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            {projects.map((p) => (
              <ProjectCard
                key={p.id}
                href={p.website || undefined}
                heading={p.name}
                subheading={p.description}
                imagePath={p.img || 'https://via.placeholder.com/800x450?text=No+Image'}
                altText={p.name}
                class="w-full"
                repo={p.repo}
                live={p.website}
              />
            ))}
          </div>
        </div>
      </div>
    </BottomLayout>
  </main>
</BaseLayout>
